- hosts: localhost
  roles:
    - role: set-nuage-vsp-facts

- hosts: all
  roles:
    - vsp-info
  tasks:
    - name: Uninstall tox
      become: yes
      pip:
        name: tox
        state: absent

    - name: Install tox with pip3
      become: yes
      command: python3 -m pip install tox

    - name: Make sure 'wheel' group exists
      become: yes
      group:
        name: wheel
        state: present

    - name: Allow 'wheel' group to have passwordless sudo
      become: yes
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%wheel'
        line: '%wheel ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'

    - name: Add tempest user to wheel group
      become: yes
      user: name=tempest groups=wheel append=yes state=present createhome=yes

    - name: Workaround uwsgi 2.0.19
      lineinfile:
        path: /opt/stack/requirements/upper-constraints.txt
        line: uwsgi===2.0.18

    - name: Workaround bandit 1.6.3
      lineinfile:
        path: /opt/stack/requirements/upper-constraints.txt
        line: bandit===1.6.2
  environment: '{{ proxy_env | default({}) }}'
