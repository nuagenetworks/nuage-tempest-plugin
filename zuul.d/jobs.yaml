- job:
    name: devstack-tempest
    parent: devstack
    # This currently works from stable/pike on.
    branches: ^(?!stable/(newton|ocata)).*$
    description: |
      Base Tempest job.

      This Tempest job provides the base for both the single and multi-node
      test setup. To run a multi-node test inherit from devstack-tempest and
      set the nodeset to a multi-node one.
    required-projects:
      - opendev.org/openstack/tempest
    timeout: 10800
    roles:
      - zuul: opendev.org/openstack/openstack-zuul-jobs
      - zuul: opendev.org/openstack/devstack
      - zuul: opendev.org/openstack/tempest
    vars:
      devstack_services:
        tempest: true
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            compute:
              min_compute_nodes: "{{ groups['compute'] | default(['controller']) | length }}"
      test_results_stage_name: test_results
      zuul_copy_output:
        '{{ devstack_base_dir }}/tempest/etc/tempest.conf': logs
        '{{ devstack_base_dir }}/tempest/etc/accounts.yaml': logs
        '{{ devstack_base_dir }}/tempest/tempest.log': logs
        '{{ stage_dir }}/{{ test_results_stage_name }}.subunit': logs
        '{{ stage_dir }}/{{ test_results_stage_name }}.html': logs
        '{{ stage_dir }}/stackviz': logs
      extensions_to_txt:
        conf: true
        log: true
        yaml: true
        yml: true
    run: playbooks/devstack-tempest.yaml
    post-run: playbooks/post-tempest.yaml

- job:
    name: tempest-full
    parent: networking-nuage-base
    # This currently works from stable/pike on.
    # Before stable/pike, legacy version of tempest-full
    # 'legacy-tempest-dsvm-neutron-full' run.
    branches: ^(?!stable/(newton|ocata)).*$
    description: |
      Base integration test with Neutron networking and py27.
      Former names for this job where:
        * legacy-tempest-dsvm-neutron-full
        * gate-tempest-dsvm-neutron-full-ubuntu-xenial
    timeout: 14400
    vars:
      tempest_test_regex: '^(tempest|neutron_tempest_plugin)\.(api|scenario)'
      tempest_test_blacklist: "{{devstack_base_dir}}/nuage-tempest-plugin/tempest-blacklist.txt"
      tempest_concurrency: 2

- job:
    name: tempest-full-vsdipam
    parent: tempest-full
    branches: ^(?!stable/(newton|ocata)).*$
    vars: &vsd_ipam_vars
      devstack_localrc:
        NUAGE_IPAM_DRIVER: "nuage_vsd_managed"
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            nuage_sut:
              ipam_driver: nuage_vsd_managed


- job:
    name: tempest-full-5.4
    parent: networking-nuage-base-5.4
    # This currently works from pike on.
    branches: ^(5.4/(pike|queens|rocky)).*$
    description: Upstream tests running against Nuage
    timeout: 14400
    vars:
      tempest_test_regex: '^(tempest|neutron_tempest_plugin)\.(api|scenario)'
      tempest_test_blacklist: "{{devstack_base_dir}}/nuage-tempest-plugin/tempest-blacklist.txt"
      tempest_concurrency: 2

- job:
    name: tempest-full-py3
    parent: networking-nuage-base-py3
    # This currently works from stable/pike on.
    # Before stable/pike, legacy version of tempest-full
    # 'legacy-tempest-dsvm-neutron-full' run.
    branches: ^(?!stable/(newton|ocata)).*$
    description: |
      Base integration test with Neutron networking and py3.
      Former names for this job where:
        * legacy-tempest-dsvm-py35
        * gate-tempest-dsvm-py35
    timeout: 14400
    vars:
      devstack_services:
        s-account: false
        s-container: false
        s-object: false
        s-proxy: false
        # without Swift, c-bak cannot run (in the Gate at least)
        c-bak: false
      tempest_test_regex: '^(tempest|neutron_tempest_plugin)\.(api|scenario)'
      tempest_test_blacklist: "{{devstack_base_dir}}/nuage-tempest-plugin/tempest-blacklist.txt"
      tempest_concurrency: 2

- job:
    name: tempest-full-py3-vsdipam
    parent: tempest-full-py3
    branches: ^(?!stable/(newton|ocata)).*$
    vars: *vsd_ipam_vars

- job:
    name: nuage-base
    abstract: true
    parent: devstack-tempest
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    description: Base abstract job for devstack/tempest based nuage jobs.
    required-projects:
      - opendev.org/openstack/devstack-gate
      - opendev.org/openstack/neutron-tempest-plugin
      - opendev.org/openstack/neutron
      - OpenStack/nuage-openstack-neutron
      - OpenStack/nuage-openstack-neutronclient
      - OpenStack/nuage-tempest-plugin
    pre-run: playbooks/pre.yaml
    irrelevant-files:
      - ^(test-|)requirements.txt$
      - ^.*\.rst$
      - ^doc/.*$
      - ^releasenotes/.*$
      - ^setup.cfg$
      - ^tools/.*$
      - ^tox.ini$
      - ^vagrant/.*$
      - ^migration/.*$
    vars:
      nuage_fip_range: "172.{{ 255 | random }}.{{ 255 | random }}"
      vsp_release: "{{ nuage_vsp_release }}"
      tox_envlist: all
      tempest_concurrency: 4
      devstack_localrc:
        FORCE: 'yes'
        LIBVIRT_TYPE: kvm
        IMAGE_URLS: "{{ image_url }}"
        DEFAULT_IMAGE_FILE_NAME: cirros-ipv6.qcow2
        DOWNLOAD_DEFAULT_IMAGES: False
        FLOATING_RANGE: "{{ nuage_fip_range }}.0/24"
        PUBLIC_NETWORK_GATEWAY: "{{ nuage_fip_range }}.1"
        Q_PLUGIN: ml2
        Q_USE_PROVIDERNET_FOR_PUBLIC: False
        Q_ML2_PLUGIN_EXT_DRIVERS: nuage_subnet,nuage_port,port_security,nuage_network
        Q_ML2_PLUGIN_TYPE_DRIVERS: vxlan,vlan,flat
        Q_ML2_PLUGIN_MECHANISM_DRIVERS: nuage,nuage_baremetal
        ML2_L3_PLUGIN: NuageL3
        PHYSICAL_NETWORK: physnet1,physnet2
        NUAGE_VSD_DEF_NETPART_NAME: "NuageCi-{{ 1000000 | random }}"
        NUAGE_FIP_UNDERLAY: True
        NUAGE_USE_METADATA: True
        NUAGE_METADATA_SHARED_SECRET: sharedsecret
        NUAGE_PAT: legacy_disabled
        OVS_BRIDGE: alubr0
      devstack_plugins:
        nuage-openstack-neutron: https://github.com/nuagenetworks/nuage-openstack-neutron.git
        nuage-openstack-neutronclient: https://github.com/nuagenetworks/nuage-openstack-neutronclient.git
        neutron-tempest-plugin: https://opendev.org/openstack/neutron-tempest-plugin
        nuage-tempest-plugin: https://github.com/nuagenetworks/nuage-tempest-plugin.git
      devstack_services:
        c-api: true
        c-sch: true
        c-vol: true
        dstat: false
        g-api: true
        g-reg: true
        keystone: true
        n-api-meta: true
        n-api: true
        n-cauth: true
        n-cond-cell1: true
        n-cpu: true
        n-novnc-cell1: true
        n-sch: true
        n-super-cond: true
        nuage-metadata-agent: true
        ovs-vswitchd: true
        ovsdb-server: true
        placement-api: true
        q-svc: true
        c-bak: false
        etcd: false
        peakmem_tracker: false
        q-agt: false
        q-dhcp: false
        q-l3: false
        q-meta: false
        q-metering: false
        s-account: false
        s-container-sync: false
        s-container: false
        s-object: false
        s-proxy: false
        horizon: false
      tempest_plugins:
        - nuage-tempest-plugin
        - neutron-tempest-plugin
      devstack_local_conf:
        post-config:
          $NEUTRON_CONF:
            DEFAULT:
              vlan_transparent: true
            quotas:
              # A negative value means unlimited. (integer value)
              quota_network: 1000
              quota_subnet: 1000
              quota_port: 1000
              quota_router: 1000
              quota_floatingip: 1000
              quota_security_group: 1000
              quota_security_group_rule: 1000
        test-config:
          $TEMPEST_CONFIG:
            scenario:
              dhcp_client: dhclient
            nuage_sut:
              image_is_advanced: true
              release: "{{ vsp_release }}"
              openstack_version: "{{ zuul.branch | basename }}"
            neutron_plugin_options:
              available_type_drivers: flat,vlan,local,vxlan
              default_image_is_advanced: true

- job:
    name: networking-nuage-base
    parent: nuage-base
    description: Base job for devstack/tempest based nuage jobs
    branches: ^(5.4|6.0)/(pike|queens|rocky|stein|train).*$
    nodeset: openstack-single-node-centos7

- job:
    name: networking-nuage-base
    parent: nuage-base
    description: Base job for devstack/tempest based nuage jobs
    branches: ^(stable)/(pike|queens|rocky|stein|train).*$
    nodeset: openstack-single-node-centos7
    vars:
      vsp_release: '20.5'

- job:
    name: networking-nuage-base
    parent: nuage-base
    description: Base job for devstack/tempest based nuage jobs
    branches: ^(?!(stable|5.4|6.0)/(pike|queens|rocky|stein|train)).*$
    nodeset: openstack-single-node-centos

- job:
    name: networking-nuage-base-py3
    parent: networking-nuage-base
    description: Base job for devstack/tempest based nuage jobs and python3.
    # release <U run on centos 7 with no metadata
    branches: ^(stable|5.4|6.0)/(pike|queens|rocky).*$
    vars:
      devstack_localrc:
        USE_PYTHON3: True
        # INF-7814 nuage-metadata-agent runs under py2 and
        # misses dependencies to python-keystoneclient
        FORCE_CONFIG_DRIVE: True

- job:
    # Job Variant for stein and train as el7 does not run metadata agent on py3
    name: networking-nuage-base-py3
    parent: networking-nuage-base
    description: Base job for devstack/tempest based nuage jobs and python3.
    branches: ^(stable|5.4|6.0)/(stein|train).*$
    vars:
      devstack_localrc:
        USE_PYTHON3: True
        # INF-7814 nuage-metadata-agent runs under py2 and
        # misses dependencies to python-keystoneclient
        FORCE_CONFIG_DRIVE: True
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            compute-feature-enabled:
              metadata_service: False

- job:
    name: networking-nuage-base-py3
    parent: networking-nuage-base
    description: Base job for devstack/tempest based nuage jobs and python3.
    # ussuri and above
    branches: ^(?!(stable|5.4|6.0)/(pike|queens|rocky|stein|train)).*$
    vars:
      devstack_localrc:
        USE_PYTHON3: True

- job:
    name: networking-nuage-base-5.4
    parent: networking-nuage-base
    description: Base job for devstack/tempest based nuage jobs against 5.4 branches
    branches: ^(5.4/(pike|queens|rocky)).*$
    nodeset: openstack-single-node-centos7
    # This currently works from pike on
    vars:
      vsp_release: '5.4'
      devstack_local_conf:
        post-config:
          $NEUTRON_CONF:
            DEFAULT:
              enable_snat_by_default: false
        test-config:
          $TEMPEST_CONFIG:
            network:
              project_network_v6_cidr: '2003::/48'
    required-projects:
      - name: OpenStack/nuage-tempest-plugin
        override-checkout: '5.4'

- job:
    name: networking-nuage-tempest-smoke
    parent: networking-nuage-base
    description: job used in gate testing smoke annotated tests
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      devstack_localrc: &mpls-type-driver-devstack
        Q_ML2_PLUGIN_TYPE_DRIVERS: vxlan,vlan,flat,nuage_hybrid_mpls
      devstack_local_conf: &mpls-type-driver-tempest
        test-config:
          $TEMPEST_CONFIG:
            neutron_plugin_options:
              available_type_drivers: flat,vlan,local,vxlan,nuage_hybrid_mpls
            nuage_sut:
              nuage_hybrid_mpls_enabled: True
      tempest_test_regex: '^(nuage_tempest_plugin|tempest\.api\.network|neutron_tempest_plugin\.(api|scenario))\..*\[(?=.*smoke)'
      tempest_black_regex: '^(?:.*(\[.*\bslow\b.*\]|neutron_tempest_plugin\.api\.admin\.test_tag.*|nuage_tempest_plugin.*orchestration.*|nuage_tempest_plugin\.tests\.scenario\.connectivity\..*\..*AggrFlowsTest\..*|tempest\.api\.network\.test_ports.*test_show_port))'

- job:
    name: networking-nuage-tempest-smoke-vsdipam
    parent: networking-nuage-tempest-smoke
    branches: ^(?!stable/(newton|ocata)).*$
    vars: *vsd_ipam_vars

- job:
    name: networking-nuage-tempest-smoke-py3
    parent: networking-nuage-base-py3
    description: job used in gate testing smoke annotated tests
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      devstack_localrc: *mpls-type-driver-devstack
      devstack_local_conf: *mpls-type-driver-tempest
      tempest_test_regex: '^(nuage_tempest_plugin|tempest\.api\.network|neutron_tempest_plugin\.(api|scenario))\..*\[(?=.*smoke)'
      tempest_black_regex: '^(?:.*(\[.*\bslow\b.*\]|neutron_tempest_plugin\.api\.admin\.test_tag.*|nuage_tempest_plugin.*orchestration.*|nuage_tempest_plugin\.tests\.scenario\.connectivity\..*\..*AggrFlowsTest\..*|tempest\.api\.network\.test_ports.*test_show_port))'

- job:
    name: networking-nuage-tempest-smoke-py3-vsdipam
    parent: networking-nuage-tempest-smoke-py3
    branches: ^(?!stable/(newton|ocata)).*$
    vars: *vsd_ipam_vars

- job:
    name: networking-nuage-tempest-smoke-5.4
    parent: networking-nuage-base-5.4
    description: job used in gate testing smoke annotated tests
    # This currently works from pike on
    branches: ^(5.4/(pike|queens|rocky)).*$
    vars:
      tempest_test_regex: '^(nuage_tempest_plugin|tempest\.api\.network|neutron_tempest_plugin\.(api|scenario))\..*\[(?=.*smoke)'
      tempest_black_regex: '^(?:.*(\[.*\bslow\b.*\]|neutron_tempest_plugin\.api\.admin\.test_tag.*|nuage_tempest_plugin.*orchestration.*))'

- job:
    name: networking-nuage-tempest-qdhcp
    parent: networking-nuage-tempest-smoke-py3
    description: job running smoke annotated tests agains q-dhcp enabled deployment
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      devstack_localrc:
        NEUTRON_AGENT: nuagevrs
      devstack_services:
        q-dhcp: true

- job:
    name: networking-nuage-tempest-qdhcp-5.4
    parent: networking-nuage-tempest-smoke-5.4
    description: job running smoke annotated tests agains q-dhcp enabled deployment
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      devstack_localrc:
        NEUTRON_AGENT: nuagevrs
      devstack_services:
        q-dhcp: true

- job:
    name: networking-nuage-tempest-virtio
    parent: networking-nuage-base
    description: job running all virtio tests
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    timeout: 18000
    vars:
      devstack_localrc: *mpls-type-driver-devstack
      devstack_local_conf: *mpls-type-driver-tempest
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\..*'
      tempest_black_regex: '^(?:.*(\[.*\bslow\b.*\]|nuage_tempest_plugin\.tests\.api\.(cli|baremetal|orchestration|test_ports_direct|l2bridge\.test_nuage_l2bridge_sriov|test_nuage_gateway|nuage_hybrid_mpls\.test_nuage_hybrid_mpls_sriov).*))'

- job:
    name: networking-nuage-tempest-virtio-vsdipam
    parent: networking-nuage-tempest-virtio
    branches: ^(?!stable/(newton|ocata)).*$
    vars: *vsd_ipam_vars

- job:
    name: networking-nuage-tempest-virtio-5.4
    parent: networking-nuage-base-5.4
    description: job running all virtio tests on 5.4 branches
    # This currently works from pike on
    branches: ^(5.4/(pike|queens|rocky)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\..*'
      tempest_black_regex: '^(?:.*(\[.*\bslow\b.*\]|nuage_tempest_plugin\.tests\.api\.(cli|baremetal|orchestration|test_ports_direct|l2bridge\.test_nuage_l2bridge_sriov|test_nuage_gateway|nuage_hybrid_mpls).*))'

- job:
    name: networking-nuage-tempest-virtio-py3
    parent: networking-nuage-base-py3
    description: job running all virtio tests with py3
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    timeout: 18000
    vars:
      devstack_localrc: *mpls-type-driver-devstack
      devstack_local_conf: *mpls-type-driver-tempest
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\..*'
      tempest_black_regex: '^(?:.*(\[.*\bslow\b.*\]|nuage_tempest_plugin\.tests\.api\.(cli|baremetal|orchestration|test_ports_direct|l2bridge\.test_nuage_l2bridge_sriov|test_nuage_gateway|nuage_hybrid_mpls\.test_nuage_hybrid_mpls_sriov).*))'

- job:
    name: networking-nuage-tempest-virtio-py3-vsdipam
    parent: networking-nuage-tempest-virtio-py3
    branches: ^(?!stable/(newton|ocata)).*$
    vars: *vsd_ipam_vars

- job:
    name: networking-nuage-tempest-api-switchdev
    parent: networking-nuage-tempest-virtio-py3
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      devstack_localrc:
        NUAGE_USE_SWITCHDEV: true
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            network:
              port_profile: capabilities:[switchdev]
              port_vnic_type: direct
      tempest_black_regex: '^(?:.*(\[.*\bslow\b.*\]|nuage_tempest_plugin\.tests\.api\.(cli|baremetal|orchestration|test_ports_direct|l2bridge\.test_nuage_l2bridge_sriov|test_nuage_gateway|nuage_hybrid_mpls\.test_nuage_hybrid_mpls_sriov|.*_with_vm.*).*))'

- job:
    name: networking-nuage-tempest-sriov
    parent: networking-nuage-base-py3
    description: job running api tests against nuage sriov mech driver
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    required-projects:
      - OpenStack/networking-testsriov
    vars:
      tempest_test_regex: '^(nuage_tempest_plugin\.tests\.api\.(test_ports_direct|l2bridge\.test_nuage_l2bridge_sriov|test_nuage_gateway|nuage_hybrid_mpls\.test_nuage_hybrid_mpls_sriov)).*'
      devstack_localrc:
        Q_ML2_PLUGIN_TYPE_DRIVERS: vxlan,vlan,flat,nuage_hybrid_mpls
        Q_ML2_PLUGIN_MECHANISM_DRIVERS: nuage,nuage_sriov,testsriov
        ML2_VLAN_RANGES: physnet1:200:300,physnet2:200:300
      devstack_plugins:
        networking-testsriov: https://github.com/nuagenetworks/networking-testsriov.git
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            network:
              port_vnic_type: direct
            neutron_plugin_options:
              available_type_drivers: flat,vlan,local,vxlan,nuage_hybrid_mpls
            nuage_sut:
              nuage_hybrid_mpls_enabled: True

- job:
    name: networking-nuage-tempest-sriov-vsdipam
    parent: networking-nuage-tempest-sriov
    vars: *vsd_ipam_vars

- job:
    name: networking-nuage-tempest-sriov-5.4
    parent: networking-nuage-base-5.4
    description: job running api tests against nuage sriov mech driver for 5.4 branches
    branches: ^(5.4/(pike|queens|rocky)).*$
    required-projects:
      - OpenStack/networking-testsriov
    vars:
      tempest_test_regex: '^(nuage_tempest_plugin\.tests\.api\.(test_ports_direct|l2bridge\.test_nuage_l2bridge_sriov|test_nuage_gateway)).*'
      devstack_localrc:
        Q_ML2_PLUGIN_MECHANISM_DRIVERS: nuage,nuage_sriov,testsriov
      devstack_plugins:
        networking-testsriov: https://github.com/nuagenetworks/networking-testsriov.git
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            network:
              port_vnic_type: direct

- job:
    name: networking-nuage-tempest-sriov-flat-vlan
    parent: networking-nuage-tempest-sriov
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    description: job running api tests against nuage sriov mech driver with allow_existing_flat_vlan
    vars:
      devstack_localrc:
        NUAGE_SRIOV_ALLOW_EXISTING_FLAT_VLAN: true

- job:
    name: networking-nuage-tempest-sriov-flat-vlan-5.4
    parent: networking-nuage-tempest-sriov-5.4
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    description: job running api tests against nuage sriov mech driver with allow_existing_flat_vlan
    vars:
      devstack_localrc:
        NUAGE_SRIOV_ALLOW_EXISTING_FLAT_VLAN: true

- job:
    name: networking-nuage-tempest-sriov-switchdev
    parent: networking-nuage-tempest-sriov
    description: job running api tests against nuage sriov mech driver with switchdev capability
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      devstack_localrc:
        NUAGE_USE_SWITCHDEV: true
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            network:
              port_profile: capabilities:[switchdev]
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\.test_ports\..*'
      tempest_black_regex: '^nuage_tempest_plugin\.tests\.api\.test_ports\.PortsTest\.test_.*_with_vm.*'

- job:
    name: networking-nuage-tempest-sriov-switchdev-5.4
    parent: networking-nuage-tempest-sriov-5.4
    description: job running api tests against nuage sriov mech driver with switchdev capability
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      devstack_localrc:
        NUAGE_USE_SWITCHDEV: true
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            network:
              port_profile: capabilities:[switchdev]
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\.test_ports\..*'
      tempest_black_regex: '^nuage_tempest_plugin\.tests\.api\.test_ports\.PortsTest\.test_.*_with_vm.*'

- job:
    name: networking-nuage-tempest-baremetal
    parent: networking-nuage-base-py3
    description: job running all baremetal tests
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\.baremetal\..*'

- job:
    name: networking-nuage-tempest-baremetal-vsdipam
    parent: networking-nuage-tempest-baremetal
    branches: ^(?!stable/(newton|ocata)).*$
    vars: *vsd_ipam_vars

- job:
    name: networking-nuage-tempest-baremetal-5.4
    parent: networking-nuage-base-5.4
    description: job running all baremetal tests on 5.4 branches
    # This currently works from pike on
    branches: ^(5.4/(pike|queens|rocky)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\.baremetal\..*'

- job:
    name: networking-nuage-tempest-scenario
    parent: networking-nuage-base-py3
    description: job running all scenario tests
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    timeout: 18000
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.scenario\..*'
      tempest_black_regex: '^nuage_tempest_plugin\.tests\.scenario\.connectivity\..*\..*AggrFlowsTest\..*'
      tempest_concurrency: 2

- job:
    name: networking-nuage-tempest-scenario-rhel
    parent: networking-nuage-tempest-scenario
    # This currently works from train on
    branches: ^(?!(stable|5.4|6.0)/(pike|queens|rocky|stein)).*$
    description: job running all scenario tests with RHEL VM's
    vars:
      tempest_concurrency: 2
      devstack_localrc:
        IMAGE_URLS: "http://openstack-infra.an.nuagenetworks.net/nuage-glance-images/rhel-7-7.qcow2"
        DEFAULT_IMAGE_FILE_NAME: rhel-7-7.qcow2
        DEFAULT_INSTANCE_USER: cloud-user
        DEFAULT_INSTANCE_TYPE: m1.small  # or use ds1G
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            scenario:
              # Interfaces with DHCP configured through cloud init network configuration
              # instead of bash script in the nuage tempest plugin
              dhcp_client: ''

- job:
    name: networking-nuage-tempest-scenario-rhel
    parent: networking-nuage-tempest-scenario
    # Variant for branches below train
    branches: ^(stable|5.4|6.0)/(pike|queens|rocky|stein).*$
    description: job running all scenario tests with RHEL VM's
    vars:
      tempest_concurrency: 2
      devstack_localrc:
        IMAGE_URLS: "http://openstack-infra.an.nuagenetworks.net/nuage-glance-images/rhel-7-7-no-network-init.qcow2"
        DEFAULT_IMAGE_FILE_NAME: rhel-7-7-no-network-init.qcow2
        DEFAULT_INSTANCE_USER: cloud-user
        DEFAULT_INSTANCE_TYPE: m1.small  # or use ds1G
      devstack_local_conf:
        test-config:
          $TEMPEST_CONFIG:
            nuage_sut:
              # Due to a cloud-init bug on branches below train (interfaces always statically configured)
              use_network_scripts: true

- job:
    name: networking-nuage-tempest-scenario-vsdipam
    parent: networking-nuage-tempest-scenario
    branches: ^(?!stable/(newton|ocata)).*$
    vars: *vsd_ipam_vars

- job:
    name: networking-nuage-tempest-scenario-5.4
    parent: networking-nuage-base-5.4
    description: job running all scenario tests on 5.4 branches
    # This currently works from pike on
    branches: ^(5.4/(pike|queens|rocky)).*$
    timeout: 18000
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.scenario\..*'
      tempest_concurrency: 2

- job:
    name: networking-nuage-tempest-cli
    parent: networking-nuage-base-py3
    description: job running all cli tests
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\.cli\..*'

- job:
    name: networking-nuage-tempest-cli-5.4
    parent: networking-nuage-base-5.4
    description: job running all cli tests on 5.4 branches
    # This currently works from pike on
    branches: ^(5.4/(pike|queens|rocky)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\.cli\..*'

- job:
    name: networking-nuage-tempest-aggregateflows
    parent: networking-nuage-tempest-scenario
    description: job running l3 vsd managed connectivity tests with aggregate flows enabled
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.scenario\.connectivity\..*\..*AggrFlowsTest\..*'
      tempest_black_regex: ''

- job:
    name: networking-nuage-tempest-scale
    parent: networking-nuage-base-py3
    description: job running all scale tests
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.scale\..*'

- job:
    name: networking-nuage-tempest-scale-5.4
    parent: networking-nuage-base-5.4
    description: job running all scale tests on 5.4 branches
    # This currently works from pike on
    branches: ^(5.4/(pike|queens|rocky)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.scale\..*'

- job:
    name: networking-nuage-tempest-lbaas-5.4
    parent: networking-nuage-base-5.4
    description: Legacy lbaas run
    branches: ^(5.4/(pike|queens|rocky)).*$
    required-projects:
      - opendev.org/openstack/neutron-lbaas
    vars:
      tempest_test_regex: '^neutron_lbaas*'
      devstack_localrc:
        NEUTRON_LBAAS_SERVICE_PROVIDERV2: LOADBALANCERV2:Haproxy:neutron_lbaas.drivers.haproxy.plugin_driver.HaproxyOnHostPluginDriver:default
      devstack_plugins:
        neutron-lbaas: https://opendev.org/openstack/neutron-lbaas.git
      tempest_plugins:
        - neutron-lbaas

- job:
    name: networking-nuage-fwaas-v1
    parent: networking-nuage-base
    branches: ".*(rocky|queens).*"
    roles:
      - zuul: openstack/devstack
    required-projects:
      - openstack/neutron-fwaas
    vars:
      tempest_test_regex: '^(neutron_fwaas.*(test_fwaas_extensions|test_fwaas)\.|nuage_tempest_plugin\.tests\.api\.test_fwaas|nuage_tempest_plugin\.tests\.scenario\.test_fwaas)'
      devstack_plugins:
        neutron-fwaas: https://opendev.org/openstack/neutron-fwaas.git
      devstack_services:
        q-fwaas-v1: true
      devstack_localrc:
        FWAAS_PLUGIN: NuageFWaaS
        USE_PYTHON3: false
        FORCE_CONFIG_DRIVE: false
        TEMPEST_PLUGINS: '"/opt/stack/nuage-tempest-plugin /opt/stack/neutron-fwaas"'
      tempest_plugins:
        - neutron-fwaas
        - nuage-tempest-plugin

- job:
    name: networking-nuage-vtep-vxlan
    parent: tempest-full-py3
    branches: ^(?!stable/(newton|ocata)).*$
    required-projects:
      - OpenStack/networking-testsriov
    vars:
      devstack_localrc:
        OVS_BRIDGE: br-int
        ML2_L3_PLUGIN: router
        Q_AGENT: openvswitch
        Q_SERVICE_PLUGIN_CLASSES: NuageAPI,NuageNetTopology,NuageL2Bridge,segments,router
        Q_ML2_PLUGIN_MECHANISM_DRIVERS: nuage_hwvtep,openvswitch,nuage_sriov,testsriov
        Q_ML2_PLUGIN_EXT_DRIVERS: nuage_subnet,port_security,nuage_network
        Q_USE_PROVIDERNET_FOR_PUBLIC: True
        PUBLIC_BRIDGE: br-ex
        OVS_PHYSICAL_BRIDGE: br-ex
        PUBLIC_PHYSICAL_NETWORK: physnet1
      devstack_services:
        q-agt: true
        q-dhcp: true
        q-meta: true
        q-l3: true
        nuage-metadata-agent: false
        s-account: true
        s-container: true
        s-container-sync: true
        s-object: true
        s-proxy: true
      devstack_plugins:
        neutron: https://opendev.org/openstack/neutron.git
        nuage-openstack-neutron: https://github.com/nuagenetworks/nuage-openstack-neutron.git
        nuage-openstack-neutronclient: https://github.com/nuagenetworks/nuage-openstack-neutronclient.git
        neutron-tempest-plugin: https://opendev.org/openstack/neutron-tempest-plugin
        networking-testsriov: https://github.com/nuagenetworks/networking-testsriov.git
      tempest_plugins:
        - neutron-tempest-plugin
      devstack_local_conf:
        post-config:
          $NEUTRON_CONF:
            quotas:
              quota_router: 100
              quota_floatingip: 500
              quota_security_group: 150
              quota_security_group_rule: 1000
            DEFAULT:
              enable_dvr: false
          /$NEUTRON_CORE_PLUGIN_CONF:
            ml2:
              type_drivers: flat,vlan,local,vxlan
            ml2_type_vlan:
              network_vlan_ranges: physnet1:1:1000
            ml2_type_vxlan:
              vni_ranges: 1:2000
            agent:
              tunnel_types: vxlan
            ovs:
              tunnel_bridge: br-tun
              bridge_mappings: physnet1:br-ex
          $NEUTRON_L3_CONF:
            agent:
              availability_zone: nova
          $NEUTRON_DHCP_CONF:
            agent:
              availability_zone: nova

- job:
    name: networking-nuage-vtep-vlan-upstream
    parent: networking-nuage-vtep-vxlan
    branches: ^(?!stable/(newton|ocata)).*$
    timeout: 21600
    vars:
      tempest_test_blacklist: ''
      tempest_black_regex: '^(?:.*(neutron_tempest_plugin\.(api\.admin\.test_routers_ha\.RoutersTestHA\.(test_delete_ha_router_keeps_ha_network_segment_data|test_ha_router_creation)|scenario\.(test_mtu|test_trunk|test_network_v6\.TestGettingAddress\.test_multi_prefix))|tempest\.api\.network\.admin\.test_routers\.RoutersIpV6AdminTest\.test_create_router_set_gateway_with_fixed_ip|tempest\.scenario\.(test_network_v6\.TestGettingAddress\.test_multi|test_network_basic_ops\.TestNetworkBasicOps\.(test_hotplug_nic|test_subnet_details|test_network_basic_ops|test_connectivity_between_vms_on_different_networks))).*)'
      devstack_localrc:
        Q_ML2_TENANT_NETWORK_TYPE: vlan

- job:
    name: networking-nuage-vtep-vlan-nuage
    parent: networking-nuage-vtep-vlan-upstream
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.api\.(test_nuage_hwvtep|ipv6\.(os_managed\.test_nuage_networks|test_os_managed_singlestack_l2_subnets|vsd_managed\.test_ipv6_subnet)|vsd_managed\.test_vsd_managed_network).*'
      tempest_black_regex: '^(?:nuage_tempest_plugin\.tests\.api\.(ipv6\.os_managed\.test_nuage_networks\.NuageNetworksIpV6TestAttrs|vsd_managed\.(.*with_vm.*|.*test_link_multi_l2domain_to_network|.*test_link_multi_l3domain_subnets_to_network)))'
      tempest_plugins:
        - nuage-tempest-plugin
      devstack_plugins:
        nuage-tempest-plugin: https://github.com/nuagenetworks/nuage-tempest-plugin.git
      devstack_localrc:
        NEUTRON_CREATE_INITIAL_NETWORKS: false

- job:
    name: networking-nuage-octavia
    parent: networking-nuage-base-py3
    description: basic nuage octavia integration job
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    timeout: 18000
    required-projects:
      - openstack/octavia
      - openstack/octavia-lib
      - openstack/octavia-tempest-plugin
      - openstack/python-octaviaclient
    vars:
      devstack_localrc:
        DEFAULT_IMAGE_NAME: cirros
        OCTAVIA_MGMT_SUBNET: 192.168.0.0/28
        OCTAVIA_MGMT_SUBNET_START: 192.168.0.2
        OCTAVIA_MGMT_SUBNET_END: 192.168.0.14
        OCTAVIA_AMP_IMAGE_FILE: ~/devstack/files/amphora-x64-haproxy.qcow2
        IMAGE_URLS: "http://openstack-infra.an.nuagenetworks.net/nuage-glance-images/cirros.qcow2, http://openstack-infra.an.nuagenetworks.net/nuage-glance-images/octavia/master/amphora-x64-haproxy.qcow2"
      devstack_local_conf:
        post-config:
          $OCTAVIA_CONF:
            DEFAULT:
              debug: True
        test-config:
          $TEMPEST_CONFIG:
            load_balancer:
              # prevent octavia tempest plugin to choose ipv6 CIDR unsupported by VSD
              vip_ipv6_subnet_cidr: cafe:b::/64
              member_1_ipv6_subnet_cidr: cafe:ba::/64
              member_2_ipv6_subnet_cidr: cafe:bab::/64
      devstack_services:
        octavia: true
        o-api: true
        o-cw: true
        o-hm: true
        o-hk: true
        o-da: true
      devstack_plugins:
        octavia: https://opendev.org/openstack/octavia.git
      tempest_plugins:
        - octavia-tempest-plugin
        - nuage-tempest-plugin
      tempest_test_regex: octavia_tempest_plugin
      # availability zone tests are a master only feature which is unstable
      tempest_black_regex: 'octavia_tempest_plugin.tests.api.v2.test_availability_zone|octavia_tempest_plugin.tests.act_stdby_scenario.v2.test_active_standby.ActiveStandbyScenarioTest'
      zuul_copy_output:
        '/var/log/dib-build' : logs

- job:
    name: networking-nuage-octavia-standby
    parent: networking-nuage-octavia
    description: nuage octavia integration job for active-standby
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    timeout: 18000
    vars:
      tempest_concurrency: 1
      devstack_local_conf:
        post-config:
          $OCTAVIA_CONF:
            controller_worker:
                loadbalancer_topology: ACTIVE_STANDBY

- job:
    name: ovs-restart
    parent: networking-nuage-base
    # This currently works from stable/pike on
    branches: ^(?!stable/(newton|ocata)).*$
    vars:
      tempest_test_regex: '^nuage_tempest_plugin\.tests\.e2e\.ovs\.test_restart_openvswitch\..*'
      tempest_concurrency: 1
